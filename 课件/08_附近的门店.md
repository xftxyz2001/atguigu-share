

# 附近门店

[TOC]

## 1、附近门店

搜索附近门店，会根据用户当前经纬度信息，获取附近几公里内的门店信息，同时还有计算当前位置到门店的距离，距离为步行的实际距离；还可以查看每个门店的费用规则信息

### 1.1、封装门店规则信息接口

#### 1.1.1、FeeRuleApiController

```java
package com.share.rules.api;


@Slf4j
@RestController
@RequestMapping("/feeRule")
@SuppressWarnings({"unchecked", "rawtypes"})
public class FeeRuleApiController {

   @Autowired
   private IFeeRuleService feeRuleService;

   @Operation(summary = "批量获取费用规则信息")
   @InnerAuth
   @PostMapping(value = "/getFeeRuleList")
   public R<List<FeeRule>> getFeeRuleList(@RequestBody List<Long> feeRuleIdList)
   {
      return R.ok(feeRuleService.listByIds(feeRuleIdList));
   }

   @Operation(summary = "获取费用规则详细信息")
   @InnerAuth
   @GetMapping(value = "/getFeeRule/{id}")
   public R<FeeRule> getFeeRule(@PathVariable("id") Long id)
   {
      return R.ok(feeRuleService.getById(id));
   }

}
```

#### 1.1.2、搭建规则服务远程接口模块

参考：share-api-system模块

##### spzx-api-rule

在share-api模块下新建子模块share-api-rule

##### pom.xml0

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns="http://maven.apache.org/POM/4.0.0"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <groupId>com.share</groupId>
        <artifactId>share-api</artifactId>
        <version>3.6.3</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>share-api-rule</artifactId>

    <description>
        share-api-rule规则接口模块
    </description>

    <dependencies>

        <!-- RuoYi Common Core-->
        <dependency>
            <groupId>com.share</groupId>
            <artifactId>share-common-core</artifactId>
        </dependency>

    </dependencies>

</project>
```

##### pom.xml

`share-modules`模块引入api依赖

```xml
<dependency>
    <groupId>com.share</groupId>
    <artifactId>share-api-rule</artifactId>
    <version>3.6.3</version>
</dependency>
```

##### FeeRule

将FeeRule对象提升到share-api-rule模块com.share.rules.api.domain包下面，订单模块要使用该对象.

操作模块：spzx-rule的FeeRule删除

#### 1.1.3、openFeign接口定义

操作模块：spzx-api-rule

##### RemoteFeeRuleService

```java
package com.share.rules.api;

@FeignClient(contextId = "remoteFeeRuleService", value = ServiceNameConstants.RULE_SERVICE, fallbackFactory = RemoteFeeRuleFallbackFactory.class)
public interface RemoteFeeRuleService {

    @PostMapping(value = "/feeRule/getFeeRuleList")
    public R<List<FeeRule>> getFeeRuleList(@RequestBody List<Long> feeRuleIdList);

    @GetMapping(value = "/feeRule/getFeeRule/{id}")
    public R<FeeRule> getFeeRule(@PathVariable("id") Long id);

}
```

##### ServiceNameConstants

```java
/**
 * 规则服务的serviceid
 */
public static final String RULE_SERVICE = "share-rule";
```

##### RemoteFeeRuleFallbackFactory

```java
package com.share.rules.api.factory;

@Component
public class RemoteFeeRuleFallbackFactory implements FallbackFactory<RemoteFeeRuleService> {
    private static final Logger log = LoggerFactory.getLogger(RemoteFeeRuleFallbackFactory.class);

    @Override
    public RemoteFeeRuleService create(Throwable throwable) {
        log.error("规则服务调用失败:{}", throwable.getMessage());
        return new RemoteFeeRuleService() {

            @Override
            public R<List<FeeRule>> getFeeRuleList(List<Long> feeRuleIdList, String source) {
                return R.fail("获取费用规则列表失败:" + throwable.getMessage());
            }

            @Override
            public R<FeeRule> getFeeRule(Long id, String source) {
                return R.fail("获取费用规则信息失败:" + throwable.getMessage());
            }
        };
    }
}
```

##### 加载配置类

resources/META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports

```
com.share.rules.api.factory.RemoteFeeRuleFallbackFactory
```



### 1.2、计算到门店的距离方法

文档地址：https://lbs.qq.com/service/webService/webServiceGuide/route/webServiceRoute

#### 1.2.1、IMapService

```java
Double calculateDistance(String startLongitude,String startLatitude,String endLongitude,String endLatitude);
```

#### 1.2.2、MapServiceImpl

```java
@Override
public Double calculateDistance(String startLongitude,String startLatitude,String endLongitude,String endLatitude) {
    String url = "https://apis.map.qq.com/ws/direction/v1/walking/?from={from}&to={to}&key={key}";

    Map<String, String> map = new HashMap<>();
    map.put("from", startLatitude + "," + startLongitude);
    map.put("to", endLatitude + "," + endLongitude);
    map.put("key", key);

    JSONObject result = restTemplate.getForObject(url, JSONObject.class, map);
    if(result.getIntValue("status") != 0) {
        throw new ServiceException("地图服务调用失败");
    }

    //返回第一条最佳线路
    JSONObject route = result.getJSONObject("result").getJSONArray("routes").getJSONObject(0);
    // 单位：米
    return route.getBigDecimal("distance").doubleValue();
}
```



### 1.3 搜索附近门店接口

#### 1.3.1 DeviceApiController

```java
@Operation(summary = "根据经纬度搜索附近门店（站点）")
@RequiresLogin
@GetMapping("/nearbyStation/{latitude}/{longitude}")
public AjaxResult nearbyStation(@PathVariable String latitude, @PathVariable String longitude)
{
    List<StationVo> stationVoList = deviceService.nearbyStation(latitude, longitude, DeviceConstants.SEARCH_H5_RADIUS);
    if (CollectionUtils.isEmpty(stationVoList)) {
    	stationService.updateData();
    }
    return success(stationVoList);
}
```

#### 1.3.2、DeviceServiceImpl

```java
@Autowired
private RemoteFeeRuleService remoteFeeRuleService;

@Autowired
private IMapService mapService;

@Override
public List<StationVo> nearbyStation(String latitude, String longitude, Integer radius) {
    //坐标，确定中心点
    // GeoJsonPoint(double x, double y) x 表示经度，y 表示纬度。
    GeoJsonPoint geoJsonPoint = new GeoJsonPoint(Double.parseDouble(longitude), Double.parseDouble(latitude));
    //画圈的半径,50km范围
    Distance d = new Distance(radius, Metrics.KILOMETERS);
    //画了一个圆圈
    Circle circle = new Circle(geoJsonPoint, d);
    //条件排除自己
    Query query = Query.query(Criteria.where("location").withinSphere(circle));
    List<StationLocation> stationLocationList = this.mongoTemplate.find(query, StationLocation.class);
    if (CollectionUtils.isEmpty(stationLocationList)) return null;

    //组装数据
    List<Long> stationIdList =stationLocationList.stream().map(StationLocation::getStationId).collect(Collectors.toList());
    //获取站点列表
    List<Station> stationList = stationService.list(new LambdaQueryWrapper<Station>().in(Station::getId, stationIdList).isNotNull(Station::getCabinetId));

    //获取柜机id列表
    List<Long> cabinetIdList = stationList.stream().map(Station::getCabinetId).collect(Collectors.toList());
    //获取柜机id与柜机信息Map
    Map<Long, Cabinet> cabinetIdToCabinetMap = cabinetService.listByIds(cabinetIdList).stream().collect(Collectors.toMap(Cabinet::getId, Cabinet -> Cabinet));

    //获取柜机id列表
    List<Long> feeRuleIdList = stationList.stream().map(Station::getFeeRuleId).collect(Collectors.toList());
    //获取柜机id与柜机信息Map
    Map<Long, FeeRule> feeRuleIdToFeeRuleMap = remoteFeeRuleService.getFeeRuleList(feeRuleIdList, SecurityConstants.INNER).getData().stream().collect(Collectors.toMap(FeeRule::getId, FeeRule -> FeeRule));

    List<StationVo> stationVoList = new ArrayList<>();
    stationList.forEach(item -> {
        StationVo stationVo = new StationVo();
        BeanUtils.copyProperties(item, stationVo);
        // 计算距离
        Double distance = mapService.calculateDistance(longitude, latitude, item.getLongitude().toString(), item.getLatitude().toString());
        stationVo.setDistance(distance);

        // 获取柜机信息
        Cabinet cabinet = cabinetIdToCabinetMap.get(item.getCabinetId());
        //可用充电宝数量大于0，可借用
        if(cabinet.getAvailableNum() > 0) {
            stationVo.setIsUsable("1");
        } else {
            stationVo.setIsUsable("0");
        }
        // 获取空闲插槽数量大于0，可归还
        if (cabinet.getFreeSlots() > 0) {
            stationVo.setIsReturn("1");
        } else {
            stationVo.setIsReturn("0");
        }

        // 获取费用规则
        FeeRule feeRule = feeRuleIdToFeeRuleMap.get(item.getFeeRuleId());
        stationVo.setFeeRule(feeRule.getDescription());

        stationVoList.add(stationVo);
    });
    return stationVoList;
}
```



测试过程中，可能出现超过调用次数限制，为了测试可以使用随机数

```java
Random random = new Random();
BigDecimal randomDouble = BigDecimal.valueOf(random.nextDouble(100));

// 保留两位小数，并进行四舍五入
BigDecimal roundedValue = randomDouble.setScale(1, RoundingMode.HALF_UP);
double roundedDoubleValue = roundedValue.doubleValue();
return roundedDoubleValue;
```



## 2、门店详情

### 2.1、DeviceApiController

```java
@Operation(summary = "根据id获取门店详情")
@RequiresLogin
@GetMapping("/getStation/{id}/{latitude}/{longitude}")
public AjaxResult getStation(@PathVariable Long id, @PathVariable String latitude, @PathVariable String longitude)
{
    return success(deviceService.getStation(id, latitude, longitude));
}
```

### 2.2、IDeviceService

```java
StationVo getStation(Long id, String latitude, String longitude);
```

### 2.3、DeviceServiceImpl

```java
@Override
public StationVo getStation(Long id, String latitude, String longitude) {
    Station station = stationService.getById(id);
    StationVo stationVo = new StationVo();
    BeanUtils.copyProperties(station, stationVo);
    // 计算距离
    Double distance = mapService.calculateDistance(longitude, latitude, station.getLongitude().toString(), station.getLatitude().toString());
    stationVo.setDistance(distance);

    // 获取柜机信息
    Cabinet cabinet = cabinetService.getById(station.getCabinetId());
    //可用充电宝数量大于0，可借用
    if(cabinet.getAvailableNum() > 0) {
        stationVo.setIsUsable("1");
    } else {
        stationVo.setIsUsable("0");
    }
    // 获取空闲插槽数量大于0，可归还
    if (cabinet.getFreeSlots() > 0) {
        stationVo.setIsReturn("1");
    } else {
        stationVo.setIsReturn("0");
    }

    // 获取费用规则
    FeeRule feeRule = remoteFeeRuleService.getFeeRule(station.getFeeRuleId(), SecurityConstants.INNER).getData();
    stationVo.setFeeRule(feeRule.getDescription());
    return stationVo;
}
```